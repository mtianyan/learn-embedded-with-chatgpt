✅ 以下是 **第 11 项课程内容：温湿度数据采集及无线传输** 的详细讲解与示例：

---

## **11、温湿度数据采集 + ESP8266 无线传输**

---

### 🎯 目标：

掌握通过 **I2C 总线** 控制温湿度传感器模块（如 DHT12、SHT30、HTU21D 等），实现实时采集温湿度数据，并利用 **ESP8266 模块** 实现无线数据传输功能。

---

### 📘 知识点：

#### 1. 温湿度传感器

* 多采用 I2C 通信协议（部分如 DHT11/22 用单线协议，不在本课重点）
* 采集温度、湿度数值
* 传感器地址及寄存器配置需查阅对应 datasheet

#### 2. I2C 总线

* STM32 的硬件 I2C 外设使用，SCL 和 SDA 两根线
* 支持主从模式，速率常用 100kHz 或 400kHz
* 读取温湿度数据，解析传感器返回值

#### 3. ESP8266 模块无线传输

* 通过 UART 与 STM32 通信
* 发送采集到的数据到服务器或手机端
* 可用 TCP/UDP/HTTP/MQTT 协议进行传输

---

### 🛠️ 硬件连接示例

| 设备         | STM32引脚         | ESP8266引脚 |
| ---------- | --------------- | --------- |
| 温湿度传感器SDA  | PB7 (I2C1\_SDA) | —         |
| 温湿度传感器SCL  | PB6 (I2C1\_SCL) | —         |
| ESP8266 TX | —               | STM32 RX  |
| ESP8266 RX | —               | STM32 TX  |

---

### 🧩 采集流程

1. 初始化 I2C 接口
2. 通过 I2C 发送读取命令到传感器
3. 读取传感器返回的温湿度数据
4. 数据处理转换成摄氏度和相对湿度百分比
5. 通过 UART 发送数据到 ESP8266
6. ESP8266 负责通过 WiFi 传输数据到服务器或手机

---

### 🧑‍💻 示例代码（基于 STM32 HAL）

```c
#include "i2c.h"
#include "usart.h"
#include <stdio.h>

#define TEMP_HUMI_ADDR 0x5C << 1 // 以DHT12为例，左移1位适应HAL库格式

uint8_t TempHumi_Buffer[5];

// 读取温湿度函数，返回0表示成功
int Read_Temp_Humi(float* temp, float* humi)
{
    HAL_StatusTypeDef ret;
    ret = HAL_I2C_Mem_Read(&hi2c1, TEMP_HUMI_ADDR, 0x00, I2C_MEMADD_SIZE_8BIT, TempHumi_Buffer, 5, 1000);
    if (ret != HAL_OK)
        return -1;

    *humi = TempHumi_Buffer[0] + TempHumi_Buffer[1] * 0.1f;
    *temp = TempHumi_Buffer[2] + TempHumi_Buffer[3] * 0.1f;

    return 0;
}
```

---

### 📡 通过 ESP8266 发送数据（示例）

```c
void Send_Data_To_Wifi(float temp, float humi)
{
    char send_buf[64];
    int len = snprintf(send_buf, sizeof(send_buf), "TEMP:%.1f,HUMI:%.1f\r\n", temp, humi);

    // 先通过 UART 发送 AT 指令建立 TCP 连接（假设已连接）
    // 发送数据长度
    char at_send[20];
    snprintf(at_send, sizeof(at_send), "AT+CIPSEND=%d\r\n", len);
    HAL_UART_Transmit(&huart1, (uint8_t*)at_send, strlen(at_send), 1000);

    HAL_Delay(100);

    // 发送数据内容
    HAL_UART_Transmit(&huart1, (uint8_t*)send_buf, len, 1000);
}
```

---

### 🔄 主循环示例

```c
int main(void)
{
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_I2C1_Init();
    MX_USART1_UART_Init();

    float temperature = 0, humidity = 0;

    while(1)
    {
        if(Read_Temp_Humi(&temperature, &humidity) == 0)
        {
            Send_Data_To_Wifi(temperature, humidity);
        }
        HAL_Delay(2000);
    }
}
```

---

### 💡 注意事项

* 温湿度传感器型号不同，读取寄存器和解析方式会不同，请查阅对应 datasheet。
* ESP8266 AT 指令初始化和连接网络请参考前面 ESP8266 章节。
* 确保电源稳定，避免干扰导致数据异常。

---

需要我帮你写具体的 I2C 驱动代码、ESP8266 AT 指令初始化流程，或者示例上位机 Python 接收代码吗？

好的，下面是第 8 项内容：**I2C（Inter-Integrated Circuit）通信协议学习笔记**，适用于你正在进行的裸机嵌入式学习路径，后面我也可以为你提供完整的 imx6ull 裸机 I2C 示例代码（含 Makefile + 启动文件 + main.c）。

---

## 🔧 8、I2C 总线通信协议与裸机开发

### 一、I2C 是什么？

**I²C（Inter-Integrated Circuit）** 是一种用于**短距离设备通信**的串行总线，通常用于 MCU 与外围芯片（如 EEPROM、RTC、温湿度传感器、OLED 等）之间的数据交换。

> 它只使用两根线即可完成主从通信：
>
> * `SCL`：时钟线
> * `SDA`：数据线

---

### 二、I2C 通信的基本特性

| 特性   | 描述                        |
| ---- | ------------------------- |
| 主从架构 | 通常 MCU 为主机，设备如 EEPROM 为从机 |
| 多主多从 | 支持多个主设备与多个从设备             |
| 地址机制 | 每个从设备有唯一 7 位地址（可拓展到 10 位） |
| 双向通信 | 主机可以读/写从机的数据              |

---

### 三、I2C 通信时序详解

#### 1. **起始位 Start Condition**

* 当 SDA 在 SCL 为高电平时从高变低，表示通信开始。

#### 2. **从地址 + R/W 位**

* 主机发送 7 位从设备地址 + 1 位读写位（0=写，1=读）

#### 3. **应答位 ACK/NACK**

* 从机拉低 SDA 表示收到地址（ACK）

#### 4. **数据传输**

* 每传输 8 bit，接收方需发送 1 bit ACK

#### 5. **停止位 Stop Condition**

* SDA 在 SCL 为高时从低变高，表示通信结束。

👇 I2C 写数据示意图：

```
START   ADDR+W  ACK   DATA1  ACK   DATA2  ACK  STOP
   |       |      |     |     |     |     |     |
   V       V      V     V     V     V     V     V
 _______   _______   _______   _______   _______
| START |-| ADDR  |-|  D1   |-|  D2   |-| STOP  |
```

---

### 四、imx6ull 的 I2C 控制器（I2C1\~I2C4）

寄存器基地址例如 I2C1：`0x021A0000`
常用寄存器：

| 寄存器        | 偏移地址 | 说明                 |
| ---------- | ---- | ------------------ |
| I2C\_I2CR  | 0x04 | 控制寄存器（启动、主模式、读写方向） |
| I2C\_I2SR  | 0x08 | 状态寄存器（忙、ACK、完成等）   |
| I2C\_I2DR  | 0x0C | 数据寄存器（收发数据）        |
| I2C\_I2ADR | 0x00 | 自身地址寄存器            |

---

### 五、裸机下使用 I2C 的基本步骤（主机模式）

1. **初始化 I2C 控制器**

   * 打开时钟
   * 配置引脚复用为 I2C（如 IOMUX 设置）

2. **设置通信频率**

   * 设置 I2C 控制器为 100kHz 或 400kHz（标准/快速）

3. **发送 START 信号**

4. **写从设备地址 + 方向位（W/R）**

5. **发送/接收数据**

6. **发送 STOP 信号**

---

### 六、I2C 通信代码片段（简化示例）

```c
void i2c_start() {
    I2C1->I2CR |= (1 << 7);  // 使能 I2C
    I2C1->I2CR |= (1 << 5);  // 主模式
    I2C1->I2CR |= (1 << 4);  // 发起 START
}

void i2c_write_byte(uint8_t data) {
    I2C1->I2DR = data;
    while (!(I2C1->I2SR & (1 << 7))); // 等待传输完成
}

void i2c_stop() {
    I2C1->I2CR &= ~(1 << 4); // 清除 MST 位 = STOP
}
```

---

### 七、常见 I2C 从设备地址

| 设备             | 地址范围（7-bit） |
| -------------- | ----------- |
| DS3231 RTC     | 0x68        |
| AT24C02 EEPROM | 0x50\~0x57  |
| SSD1306 OLED   | 0x3C 或 0x3D |
| SHT30 温湿度      | 0x44        |

---

### 八、常见错误及调试方法

| 问题     | 原因                      | 解决办法               |
| ------ | ----------------------- | ------------------ |
| 从设备无应答 | 地址错误 / I2C线未接好          | 确认地址、检查接线          |
| 数据收发混乱 | 时序问题 / 未正确产生 START/STOP | 确保状态机正确            |
| 总线被拉低  | 器件死锁 / I2C线路问题          | 断电重启从设备，检查 SDA/SCL |

---

### 九、配套裸机例子：读写 DS3231 RTC 模块

> 可提供：

* 完整工程结构
* `main.c` 实现读取 DS3231 时间
* `Makefile` 编译支持
* `start.S` 启动文件
* `i2c.c/h` 驱动层

---

需要我现在为你生成 `imx6ull_i2c_ds3231_demo` 裸机项目结构和代码吗？你也可以指定其他 I2C 设备，我可以根据你的实际模块编写驱动。是否继续？

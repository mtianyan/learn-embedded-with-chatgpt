下面是第8周·课程内容的第7项：**超声波避障** 的详细讲解与实践指南。

---

## 🤖 7. 超声波避障 —— 小车自主避障控制

---

### 🎯 一、课程目标

掌握超声波测距原理，学会编程控制超声波模块测量障碍物距离，并结合小车控制逻辑，实现简单的自主避障功能。

---

### 📡 二、超声波测距模块（如 HC-SR04）介绍

| 引脚   | 功能说明                |
| ---- | ------------------- |
| VCC  | 电源（5V）              |
| GND  | 地线                  |
| TRIG | 触发测距信号输入            |
| ECHO | 接收返回信号输出（高电平脉宽表示距离） |

#### ⏱️ 测距原理：

1. MCU 触发 TRIG → 发送 10μs 脉冲；
2. 模块发出超声波；
3. 遇到障碍物反射回来；
4. ECHO 引脚输出一个高电平，**高电平持续时间 ∝ 距离**；
5. MCU 读取高电平持续时间 `t`；
6. 计算距离：

```text
距离 = (t × 声速) ÷ 2
     = t / 58.0 （单位：cm）
```

---

### 📐 三、硬件连接图（示意）

| 超声波模块 | STM32 单片机    |
| ----- | ------------ |
| VCC   | 5V           |
| GND   | GND          |
| TRIG  | PB10         |
| ECHO  | PB11（需定时器捕获） |

---

### 🧠 四、STM32 控制流程

```text
1. 发送 TRIG 脉冲（10μs 高电平）；
2. 等待 ECHO 高电平开始；
3. 用定时器捕获 ECHO 高电平持续时间；
4. 计算距离；
5. 距离小于设定阈值（如 20cm）则避障；
6. 结合电机控制：前进 / 后退 / 转向。
```

---

### 🧰 五、核心代码（基于标准库）

#### 1. TRIG 脉冲发送

```c
void Ultrasonic_Trig_Send(void)
{
    GPIO_SetBits(GPIOB, GPIO_Pin_10);
    delay_us(10); // 保持10微秒
    GPIO_ResetBits(GPIOB, GPIO_Pin_10);
}
```

#### 2. ECHO 高电平时间捕获（需定时器输入捕获配置）

```c
uint32_t Ultrasonic_Get_Distance(void)
{
    Ultrasonic_Trig_Send();

    // 等待 ECHO 高电平
    while (GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_11) == 0);
    TIM_SetCounter(TIM2, 0);
    
    // 等待 ECHO 变低
    while (GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_11) == 1);
    uint32_t t = TIM_GetCounter(TIM2);

    return t / 58;  // 距离（cm）
}
```

---

### 🧭 六、小车避障控制逻辑

```c
void Car_Auto_Avoid(void)
{
    uint32_t distance = Ultrasonic_Get_Distance();
    
    if (distance < 20)
    {
        Car_Stop();
        delay_ms(500);
        Car_Backward();  // 后退
        delay_ms(500);
        Car_Turn_Left(); // 向左避障
        delay_ms(500);
    }
    else
    {
        Car_Forward();   // 前进
    }
}
```

---

### 🔁 七、主循环运行

```c
int main(void)
{
    Motor_Init();
    Ultrasonic_Init();
    Timer_Init(); // 用于计时 ECHO
    
    while (1)
    {
        Car_Auto_Avoid();
        delay_ms(100);
    }
}
```

---

### 🧪 八、调试建议

* 可在串口打印测距结果调试：

  ```c
  printf("distance = %d cm\r\n", distance);
  ```
* 使用万用表测量 TRIG、ECHO 是否有脉冲；
* 注意 ECHO 为输入引脚，不能配置为推挽输出；
* 可调整避障阈值（如从 20 改成 15 或 30）。

---

### ✅ 九、扩展方向

| 扩展内容    | 说明                |
| ------- | ----------------- |
| 多个超声波模块 | 前/左/右 同时避障        |
| 结合舵机    | 舵机带动超声波模块旋转扫描     |
| 结合红外传感器 | 多重传感避障            |
| 地图规划    | 使用寻迹、路线记录等方式提高智能化 |

---

如果你使用 HAL 库、CubeMX 或有具体引脚不一样，我也可以帮你适配版本。需要我补充 HAL/CubeMX 配置或驱动文件吗？
